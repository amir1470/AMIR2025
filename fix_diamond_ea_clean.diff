--- a/DIAMOND_EA_FIXED.mq5
+++ b/DIAMOND_EA_FIXED.mq5
@@
-#define clrGray C'100,100,100'
+// Le gris generique existe deja dans MQL5 -> on retire la redefintion
+// Si vous voulez un ton personnalise : #define clrMediumGray C'100,100,100'

@@
+//--------------------------------------------------------------------+
+//  SECTION 1.bis : Wrappers MQL4 -> MQL5 pour compatibilite          +
+//--------------------------------------------------------------------+
+
+// Equivalent MQL4 : IsConnected() (n'existe pas en MQL5)
+bool IsConnected()
+  { return (bool)TerminalInfoInteger(TERMINAL_CONNECTED); }
+
+// Equivalent MQL4 : MathIsNaN()
+bool MathIsNaN(double v)
+  { return !(v==v); }
+
+// Lecture simplifiee de l'ATR courant (rend directement la valeur)
+double GetATR(string symbol, ENUM_TIMEFRAMES tf, int period, int shift=0)
+{
+   static int h = INVALID_HANDLE, lastTF = 0, lastPrd = -1;
+   if(h==INVALID_HANDLE || tf!=lastTF || period!=lastPrd)
+   {
+      if(h!=INVALID_HANDLE) IndicatorRelease(h);
+      h = iATR(symbol, tf, period);
+      lastTF = tf;  lastPrd = period;
+   }
+   if(h==INVALID_HANDLE) return 0.0;
+   double buf[];
+   if(CopyBuffer(h,0,shift,1,buf)!=1) return 0.0;
+   return buf[0];
+}
+
+//--------------------------------------------------------------------+
+//  Liste blanche des symboles autorises (fix : erreur "static array")
+//--------------------------------------------------------------------+
+string const ALLOWED_SYMBOLS[] =
+   {"EURUSDm","USDJPYm","EURGBPm","XAUUSDm","GOLDm","BTCUSD"};

@@ class CTradeManager
-   void ManageTrailingStop(ulong ticket, ENUM_POSITION_TYPE type, double entry, double &sl, double tp)
+   void ManageTrailingStop(ulong ticket, ENUM_POSITION_TYPE type, double entry, double sl, double tp)

@@ ManageTrailingStop()
-      double atr = iATR(_Symbol, _Period, atrPeriod);
+      double atr = GetATR(_Symbol, _Period, atrPeriod);

@@ GetDynamicSpreadThreshold()
-      double atr = iATR(symbol, _Period, 14);
+      double atr = GetATR(symbol, _Period, 14);

@@ UpdateStrategyWeights()
-            double atr = iATR(_Symbol, _Period, 14);
+            double atr = GetATR(_Symbol, _Period, 14);

@@ DetectMarketAnomaly()
-    double atr = iATR(_Symbol, _Period, 14);
+    double atr = GetATR(_Symbol, _Period, 14);
-        meanATR += iATR(_Symbol, _Period, 14, i);
+        meanATR += GetATR(_Symbol, _Period, 14, i);

@@ OnTick()
-    double atr = iATR(_Symbol, _Period, ATRPeriod, 0);
+    double atr = GetATR(_Symbol, _Period, ATRPeriod, 0);

@@ DisplayLabel()
-   ObjectSetInteger(0, name, OBJPROP_BOLD, bold ? true : false);
+#ifdef OBJPROP_FONT_BOLD
+   ObjectSetInteger(0, name, OBJPROP_FONT_BOLD, bold);
+#endif

@@ OnInit()
-    string allowedSymbols[] = {"EURUSDm", "USDJPYm", "EURGBPm", "XAUUSDm", "GOLDm", "BTCUSD"};
-    bool symbolAllowed = false;
-    for(int i = 0; i < ArraySize(allowedSymbols); i++) {
-        if(Symbol() == allowedSymbols[i]) {
+    bool symbolAllowed = false;
+    for(int i = 0; i < ArraySize(ALLOWED_SYMBOLS); i++) {
+        if(_Symbol == ALLOWED_SYMBOLS[i]) {
             symbolAllowed = true;
             break;
         }